<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Printer</title>
    <style>
        .input-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .input-group label {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="input-group">
        <label for="text">Text:</label>
        <input type="text" id="text">
    </div>
    <div class="input-group">
        <label for="darkness">Darkness:</label>
        <input type="number" id="darkness">
    </div>
    <div class="input-group">
        <label for="speed">Speed:</label>
        <input type="number" id="speed">
    </div>
    <div class="input-group">
        <label for="size">Size:</label>
        <input type="number" id="size">
    </div>
    <button id="toggle-logo">Fresh Logo</button>
    <button onclick="printBarcode()">Print Barcode</button>

    <script>
        let selected_device;
        let logoToggled = false;

        document.getElementById("toggle-logo").addEventListener("click", () => {
            logoToggled = !logoToggled;
            alert(`Fresh Logo ${logoToggled ? 'enabled' : 'disabled'}`);
        });

        const addDeviceToList = (device) => {
            const html_select = document.getElementById("selected_device");
            const option = document.createElement("option");
            option.text = device.name;
            option.value = device.uid;
            html_select.add(option);
        };

        const setup = () => {
            BrowserPrint.getDefaultDevice("printer", device => {
                selected_device = device;
                addDeviceToList(device);

                BrowserPrint.getLocalDevices(device_list => {
                    device_list.forEach(device => {
                        if (!selected_device || device.uid !== selected_device.uid) {
                            addDeviceToList(device);
                        }
                    });
                }, () => alert("Error getting local devices"), "printer");
            }, error => alert(error));
        };

        const getConfig = () => {
            BrowserPrint.getApplicationConfiguration(
                config => alert(JSON.stringify(config)),
                error => alert(JSON.stringify(new BrowserPrint.ApplicationConfiguration()))
            );
        };

        const printBarcode = () => {
            const text = document.getElementById("text").value;
            const darkness = document.getElementById("darkness").value;
            const speed = document.getElementById("speed").value;
            const size = document.getElementById("size").value;

            let zplCommand = `^XA` + // Start label format
                             `^PW400` + // Set print width to 400 dots (4 inches)
                             `^LL300` + // Set label length to 300 dots (3 inches)
                             `^MD${darkness}` + // Set darkness level
                             `^PR${speed}` + // Set print speed
                             `^FO50,75` + // Centered X position (50 dots), Y position (75 dots)
                             `^BCN,${size},Y,N,N,N,D` + // Barcode type Code128, height based on user input
                             `^FD${text}^FS`; // Field data (barcode content)

            if (logoToggled) {
                zplCommand += `^FO50,150^GFA,${getLogoData()}^FS`; // Add logo if toggled
            }

            zplCommand += `^XZ`; // End label format

            selected_device.send(zplCommand, undefined, errorCallback);
        };

        const getLogoData = () => {
            // This function should return the ZPL data for the fresh.png logo.
            // For simplicity, let's assume it returns a placeholder string.
            return "logo_data_placeholder";
        };

        const errorCallback = (errorMessage) => {
            alert("Error: " + errorMessage);
        };

        const onDeviceSelected = (selected) => {
            selected_device = devices.find(device => selected.value == device.uid);
        };

        setup();
    </script>
</body>
</html>